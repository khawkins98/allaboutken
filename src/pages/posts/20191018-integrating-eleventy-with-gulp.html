---
title: "Integrating Eleventy with gulp, upstream JS"
layout: default
teaser: "Eleventy <a href='https://www.11ty.io/docs'>notes that</a> it, \"works great with data — use both front matter and external data files\" but the static site generator stops short of working well with upstream in-memory data objects."
image: "/blog/dripping-faucet.jpg"
date: 2019-10-18
url: /posts/20191018-integrating-eleventy-with-gulp.html
active_path: blog
topics:
  - gulp, Eleventy, EMBL
---

<div class="medium-12 cell padding-top-large">

<div class="grid-x padding-bottom-medium padding-top-large padding-bottom-large">
  <figure class="large-10 medium-8 cell callout"><img class="padding-bottom-medium" src="{{root}}images/original{{image}}" />
    <cite class="text-right">Thanks to Flickr user Paul B for the image [<a href="https://www.flickr.com/photos/eastbeach/24818842988/in/photolist-DPa4m1-4eQ9W-4bPwdN-APyyy-eXwGJg-4JZhcq-6wASuN-6wwH86-6wASy7-7zwzso-wGnk7F-8HPAJt-66a7wt-4fPSa-tzkuC-tMM3hb-5njkrD-5C83sD-tzkqk-5oynfL-4pnkBU-6ZfA9m-6iZaMo-7ECykH-9sAPMe-TcFhPs-6zJcWE-4eQ9Y-5styJG-9Tshp1-nu54P-6iUT2t-xZYcY-7DbDxo-6aVvan-gsyhW8-95sAwV-gsyhHn-2cL3sdx-unNuB-gxE7Hm-3fArXA-xxCk6-6iUYaX-gsxDY2-unNiy-67GWCn-xxCsQ-gsy2m3-4Cnf2b">CC License</a>]</cite>
    <figcaption>Drip. Drop. Drip. Opening the tap of of upstream data objects for Eleventy.</figcaption>
  </figure>
</div>

{{#markdown}}
{{#date}}{{this.date}}{{/date}} &nbsp; &nbsp;<span class="label">Filed in: {{this.topics}}</span>

<div class="grid-x">
<div class="large-11 medium-12 cell">
<h1>{{title}}</h1>
</div>
</div>

<p class="lead">{{{teaser}}}</p>

This post is prompted by a project for a highly-modular design system as part of my work for [EMBL](https://www.embl.de) — a leading laboratory for the life sciences. We're using Eleventy with gulp (for task running and building) and [Fractal](https://fractal.build) (for design components). 

We wanted to:

1. Have gulp to trigger a build of Eleventy
1. Use Eleventy’s watch/refresh commands for local development
1. Send variables to Eleventy’s JavaScript data files from gulp (or other Node JS tasks)

There are methods to achieve part 1 but not with part 2 and 3. But we made a solution. 

> #### tl;dr: I forked 11ty’s cmd.js to better integrate with gulp and other Node JS. I hope Eleventy’s maintainer’s can take some inspiration from this. I made [a demo at khawkins98/gulp-eleventy](https://github.com/khawkins98/gulp-eleventy).

Still here? Great. Read on.

<br/>

#### Scenario

## I’m a parent process with some data, please use it

Fractal’s component management creates a really useful JavaScript object that lists the component file structure and contents of components; an illustrative example:

```js
fractalComponents = {
  component: “myComponent”,
  files: {
    “myComponent.css”: {
       “Contents of the CSS”
     },
    “myComponent.njk”: {
       “Contents of the NJK template”
     },
    “CHANGELOG.md”: {
       “Contents of the changelog”
     },
    “README.md”: {
       “Contents of the readme”
     }
     … and so on
```

And Fractal also builds components into nested Nunjuck templates. 

In principle we could get Eleventy to do the same tasks, scanning the file system and rendering our templates -- but we didn’t want to duplicate our build process -- especially considering that both Eleventy and Fractal were already running in Node JS. 

## Elventy, can you hear me? 
### Getting Eleventy to hear Fractal

While Eleventy has a very nice feature supporting [JavaScript data files](https://www.11ty.io/docs/data-js/), there’s unfortunately no equivalent method to:

- Specify a data variable _and_
- Make Eleveny refresh if that variable changes or parent task asks (like `gulp watch`)

So although we had an event when Fractal updated it’s variable (`fractal.components.on('updated',`) it wasn’t possible to get Eleventy to trigger a rebuild and pull in the new data.



Eleventy’s main execution lives in [`cmd.js`](https://github.com/11ty/eleventy/blob/master/cmd.js) and the `elev` variable we need access to lives inside a `try` statement with no exports.


I forked 11ty’s cmd.js to better integrate with gulp. 

I hope the project takes some inspiration from this. 

I have a demo repository: https://github.com/khawkins98/gulp-eleventy

Gulp can now ask Eleveny to be more of true child task

Eleventy should write files and then Gulp can go on to the next task:

```js
gulp.task('eleventy:build', function(done) {
  elev.write().then(function() {
    console.log('Done building 11ty');
    done();
  });
});
```

Do a deep rebuild of Eleventy when a file outside of Eleventy’s scope changes or an event trigger is received: 

```js
gulp.task('eleventy:reload', function(done) {
  elev.restart()
  elev.write()
});
```

## Aside: Child process won’t get us there
### Unless you like dumping memory to disk

One method we initially considered was using Node’s [`child_process`](https://nodejs.org/api/child_process.html). This is quite clean and is used below by zellwk.com:

From [`master/gulp/eleventy.js`](https://github.com/zellwk/zellwk.com/blob/master/gulp/eleventy.js)

```js
const exec = require('child_process').exec

const eleventy = cb => {
  const command = 'eleventy'

  exec(command, function (err, stdout, stderr) {
    console.log(stdout)
    console.log(stderr)
    cb(err)
  })
}
```

Using this method you’re also able to run Eleventy with a nice callback on completion — the downside to this method is there’s no clean way to pass in-memory objects to the `child_process`, you’d need to stringify:

```js
require('child_process').fork('./child.js', [], { env: { FOO: 'bar' } });
```

Far from impossible, but unpleasant. And you’d also need to re-invoke Eleventy every time during local development, losing Eleventy’s `watch` command.

What we want to do is get Eleventy playing in the same process as our other Node JS. 



<!--
<div class="grid-x padding-bottom-medium padding-top-large padding-bottom-large">
<figure class="callout large-12 cell">
<img src="{{root}}images/original/blog/xxxx.jpg" />
<figcaption><strong>Figure 1.</strong> Caption.
</figcaption>
</figure>
</div>
-->

{{/markdown}}
</div>

{{> footer}}
